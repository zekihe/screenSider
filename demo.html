<!doctype html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<title>摄像头握拳翻牌</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<style>
html,body{height:100%;margin:0;background:#111;display:flex;align-items:center;justify-content:center;color:#fff;flex-direction:column}
#video{position:fixed;top:0;left:0;width:120px;border-radius:6px;transform:scaleX(-1)}
.card-box{width:200px;height:300px;perspective:900px}
.card{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .35s}
.face{position:absolute;width:100%;height:100%;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:30px;backface-visibility:hidden}
.front{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.back{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);transform:rotateY(180deg)}
</style>
</head>
<body>
<video id="video" autoplay muted playsinline></video>
<div class="card-box">
  <div class="card" id="card">
    <div class="face front">正面</div>
    <div class="face back">背面</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.min.js"></script>
<script>
/* ================== 全局变量 ================== */
const video  = document.getElementById('video');
const card   = document.getElementById('card');
let isBack   = false;   // 当前是否背面
let wasFist  = false;   // 上一帧是否握拳

/* 计算两点距离 */
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);

/* 判定单手是否握拳 */
function isFist(landmarks){
  // 指尖索引：4 8 12 16 20，对应掌指关节：3 6 10 14 18
  const tips   = [4,8,12,16,20];
  const mcps   = [3,6,10,14,18];
  const threshold = 0.06; // 归一化坐标下的经验阈值，可微调
  for(let i=0;i<5;i++){
    if(dist(landmarks[tips[i]],landmarks[mcps[i]]) > threshold) return false;
  }
  return true;
}

/* 翻转卡牌 */
function flipCard(){
  isBack = !isBack;
  card.style.transform = isBack ? 'rotateY(180deg)' : 'rotateY(0deg)';
}

/* ================== MediaPipe 初始化 ================== */
async function init(){
  const hands = new Hands({locateFile:file=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`});
  hands.setOptions({
    maxNumHands:1,
    modelComplexity:1,
    selfieMode:true,
    minDetectionConfidence:0.7,
    minTrackingConfidence:0.7
  });

  hands.onResults(results=>{
    console.log(results)
    if(!results.multiHandLandmarks.length){ // 手离开画面
      wasFist = false;
      return;
    }
    const landmarks = results.multiHandLandmarks[0];
    const fist = isFist(landmarks);
    if(fist && !wasFist){      // 上升沿：刚握拳
      flipCard();
    }
    wasFist = fist;
  });

  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
  video.srcObject = stream;

  const camera = new Camera(video,{
    onFrame: async () => await hands.send({image:video}),
    width:640,height:480
  });
  camera.start();
}

init().catch(err=>alert('启动失败：'+err));
</script>
</body>
</html>
