<!DOCTYPE html>
<html lang="en">
<head>
    <title>screen shot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        #preview {
            width: 200px; 
            height: 200px; 
            /* border: 1px solid #333; */
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <video id="preview" autoplay playsinline></video>
    <div>
        <button id="startBtn">开始录制</button>
        <button id="stopBtn" disabled>停止录制</button>
        <span id="recordTime">录制时长：00:00</span>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        let mediaRecorder; // 录制器实例
        let stream; // 摄像头流
        let recordTimer = null; // 录制计时器
        let seconds = 0; // 录制秒数

        // 1. 初始化摄像头
        async function initCamera() {
            try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { width: 1280, height: 720, facingMode: 'user' }, // 优先前置摄像头
                audio: true // 同时录制音频（可选）
            });
            document.getElementById('preview').srcObject = stream;
            } catch (err) {
            alert('无法访问摄像头/麦克风：' + err.message);
            console.error(err);
            }
        }

        // 2. 格式化录制时长（秒 → 00:00）
        function formatTime(sec) {
            const minutes = Math.floor(sec / 60).toString().padStart(2, '0');
            const secs = (sec % 60).toString().padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        // 3. 开始录制
        document.getElementById('startBtn').addEventListener('click', async () => {
            if (!stream) await initCamera();

            // 创建录制器（指定MP4格式，可调整编码参数）
            mediaRecorder = new MediaRecorder(stream, {
            mimeType: 'video/mp4',
            videoBitsPerSecond: 5000000 // 视频码率（5Mbps，影响文件大小和清晰度）
            });

            // 收集录制的视频片段
            const chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

            // 录制结束后处理文件
            mediaRecorder.onstop = async () => {
            clearInterval(recordTimer); // 停止计时
            seconds = 0;
            document.getElementById('recordTime').textContent = '录制时长：00:00';

            // 合并片段为Blob
            const videoBlob = new Blob(chunks, { type: 'video/mp4' });
            // 转为Buffer发送给主进程保存
            const arrayBuffer = await videoBlob.arrayBuffer();
            const buffer = Buffer.from(arrayBuffer);
            ipcRenderer.send('save-video', buffer);
            };

            // 开始录制并启动计时
            mediaRecorder.start();
            recordTimer = setInterval(() => {
            seconds++;
            document.getElementById('recordTime').textContent = `录制时长：${formatTime(seconds)}`;
            }, 1000);

            // 更新按钮状态
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
        });

        // 4. 停止录制
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop(); // 停止录制
            // 不关闭摄像头，允许再次录制
            // stream.getTracks().forEach(track => track.stop()); 
            }
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        });

        // 初始化摄像头
        initCamera();
    </script>
</body>
</html>